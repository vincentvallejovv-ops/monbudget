<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>MonBudget Multi Profils</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    :root{
      --primary:#2563EB;--primary-dark:#1E40AF;--success:#10B981;
      --danger:#EF4444;--warning:#F59E0B;--bg:#F3F4F6;
      --surface:#FFFFFF;--text:#1F2937;--text-light:#6B7280;--border:#E5E7EB
    }
    body{
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
      background:var(--bg);color:var(--text);padding-bottom:80px
    }
    .header{
      background:linear-gradient(135deg,var(--primary)0%,var(--primary-dark)100%);
      color:#fff;padding:1.5rem 1rem;position:sticky;top:0;z-index:100;
      box-shadow:0 4px 12px rgba(0,0,0,.15)
    }
    .header h1{
      font-size:1.4rem;font-weight:700;display:flex;align-items:center;gap:.5rem
    }
    .container{max-width:1200px;margin:0 auto;padding:1rem}
    .card{
      background:var(--surface);border-radius:16px;padding:1.25rem;margin-bottom:1rem;
      box-shadow:0 2px 8px rgba(0,0,0,.06)
    }
    .card-title{
      font-size:1.1rem;font-weight:600;margin-bottom:1rem;display:flex;gap:.5rem;align-items:center
    }
    .stat-grid{
      display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
      gap:1rem;margin-bottom:1.5rem
    }
    .stat-card{
      border-radius:14px;padding:1.5rem;color:#fff;
      background:linear-gradient(135deg,var(--primary)0%,var(--primary-dark)100%)
    }
    .stat-card.success{background:linear-gradient(135deg,var(--success)0%,#059669 100%)}
    .stat-card.danger{background:linear-gradient(135deg,var(--danger)0%,#DC2626 100%)}
    .stat-label{font-size:.8rem;opacity:.95;margin-bottom:.35rem}
    .stat-value{font-size:1.4rem;font-weight:700}
    .btn{
      padding:.6rem 1.2rem;border:none;border-radius:8px;font-size:.9rem;font-weight:600;
      cursor:pointer;display:inline-flex;align-items:center;gap:.4rem;transition:.2s;
      text-decoration:none
    }
    .btn-primary{background:var(--primary);color:#fff}
    .btn-primary:hover{background:var(--primary-dark);transform:translateY(-1px)}
    .btn-success{background:var(--success);color:#fff}
    .btn-danger{background:var(--danger);color:#fff}
    .btn-secondary{background:var(--border);color:var(--text)}
    .btn-icon{
      border:none;background:transparent;cursor:pointer;color:var(--text-light);
      padding:.2rem .4rem;border-radius:6px
    }
    .btn-icon:hover{background:var(--border);color:var(--danger)}
    .fab{
      position:fixed;bottom:90px;right:1.2rem;width:56px;height:56px;border-radius:50%;
      background:linear-gradient(135deg,var(--primary)0%,var(--primary-dark)100%);
      color:#fff;border:none;font-size:1.4rem;display:flex;align-items:center;
      justify-content:center;cursor:pointer;box-shadow:0 6px 16px rgba(37,99,235,.5);
      z-index:90
    }
    .bottom-nav{
      position:fixed;bottom:0;left:0;right:0;background:var(--surface);
      border-top:1px solid var(--border);display:flex;justify-content:space-around;
      padding:.6rem 0;z-index:100
    }
    .nav-item{
      display:flex;flex-direction:column;align-items:center;gap:.15rem;
      font-size:.7rem;color:var(--text-light);padding:.4rem .8rem;border-radius:8px;
      cursor:pointer
    }
    .nav-item.active{color:var(--primary);background:rgba(37,99,235,.1)}
    .nav-item i{font-size:1.2rem}
    .page{display:none}
    .page.active{display:block}
    .transaction-list{display:flex;flex-direction:column;gap:.6rem}
    .transaction-item{
      display:flex;align-items:center;gap:.7rem;padding:.75rem;border-radius:10px;
      border:1px solid var(--border);background:#fff
    }
    .transaction-icon{
      width:40px;height:40px;border-radius:999px;display:flex;align-items:center;
      justify-content:center;font-size:1.2rem
    }
    .transaction-icon.expense{background:rgba(239,68,68,.1);color:var(--danger)}
    .transaction-icon.income{background:rgba(16,185,129,.1);color:var(--success)}
    .transaction-info{flex:1}
    .transaction-category{font-weight:600;font-size:.9rem}
    .transaction-description{font-size:.75rem;color:var(--text-light)}
    .transaction-meta{font-size:.7rem;color:var(--text-light)}
    .transaction-amount{font-weight:700;font-size:.95rem}
    .transaction-amount.expense{color:var(--danger)}
    .transaction-amount.income{color:var(--success)}
    .form-group{margin-bottom:1rem}
    .form-label{display:block;margin-bottom:.35rem;font-size:.85rem;font-weight:600}
    .form-input,.form-select{
      width:100%;padding:.6rem;border-radius:8px;border:1px solid var(--border);
      font-size:.9rem
    }
    .form-row{display:flex;gap:.6rem}
    .form-row>*{flex:1}
    .modal{
      position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.55);
      display:none;align-items:center;justify-content:center;z-index:200;
      padding:1rem
    }
    .modal.active{display:flex}
    .modal-content{
      background:#fff;border-radius:16px;max-width:520px;width:100%;
      max-height:90vh;overflow-y:auto;padding:1.5rem
    }
    .modal-title{font-size:1.1rem;font-weight:700;margin-bottom:1rem}
    .tabs{display:flex;gap:.4rem;margin-bottom:1rem;border-bottom:1px solid var(--border)}
    .tab{
      border:none;background:none;padding:.5rem 1rem;font-size:.85rem;font-weight:600;
      color:var(--text-light);cursor:pointer;border-bottom:2px solid transparent
    }
    .tab.active{color:var(--primary);border-bottom-color:var(--primary)}
    .toast{
      position:fixed;bottom:95px;left:50%;transform:translateX(-50%);
      background:var(--text);color:#fff;padding:.7rem 1.4rem;border-radius:999px;
      font-size:.85rem;display:none;z-index:300
    }
    .toast.show{display:block}
    .pill-filter{display:flex;flex-wrap:wrap;gap:.4rem;margin-bottom:.6rem}
    .pill{
      padding:.25rem .7rem;border-radius:999px;border:1px solid var(--border);
      font-size:.75rem;cursor:pointer;color:var(--text-light)
    }
    .pill.active{background:var(--primary);color:#fff;border-color:var(--primary)}
    .small-text{font-size:.75rem;color:var(--text-light)}
    .empty-state{text-align:center;padding:2rem 1rem;color:var(--text-light);font-size:.85rem}
    .badge{
      display:inline-block;padding:.1rem .4rem;border-radius:999px;
      font-size:.7rem;background:var(--border);color:var(--text-light)
    }
    @media(max-width:768px){
      .stat-grid{grid-template-columns:1fr}
      .modal-content{padding:1.1rem}
    }
  </style>
</head>
<body>
<div class="header">
  <h1><i class="fas fa-wallet"></i> MonBudget Multi Profils</h1>
</div>

<!-- Dashboard -->
<div id="dashboard-page" class="page active">
  <div class="container">
    <div class="pill-filter" id="profile-filter"></div>
    <div class="stat-grid">
      <div class="stat-card">
        <div class="stat-label">Solde total</div>
        <div class="stat-value" id="total-balance">0 â‚¬</div>
      </div>
      <div class="stat-card success">
        <div class="stat-label">Revenus mois courant</div>
        <div class="stat-value" id="month-income">0 â‚¬</div>
      </div>
      <div class="stat-card danger">
        <div class="stat-label">Depenses mois courant</div>
        <div class="stat-value" id="month-expenses">0 â‚¬</div>
      </div>
    </div>

    <div class="card">
      <div class="card-title">
        <i class="fas fa-clock"></i> Dernieres transactions
      </div>
      <div id="recent-transactions" class="transaction-list"></div>
    </div>

    <div class="card">
      <div class="card-title">
        <i class="fas fa-bullseye"></i> Objectifs d'epargne
      </div>
      <div id="goals-summary"></div>
    </div>
  </div>
</div>

<!-- Transactions -->
<div id="transactions-page" class="page">
  <div class="container">
    <div class="card">
      <div class="card-title">
        <i class="fas fa-exchange-alt"></i> Transactions
      </div>
      <div class="tabs">
        <button class="tab active" data-filter="all">Toutes</button>
        <button class="tab" data-filter="expense">Depenses</button>
        <button class="tab" data-filter="income">Revenus</button>
      </div>
      <div id="transactions-list" class="transaction-list"></div>
    </div>
  </div>
</div>

<!-- PÃ©riodes -->
<div id="budgets-page" class="page">
  <div class="container">
    <div class="card">
      <div class="card-title">
        <i class="fas fa-calendar-alt"></i> Vue mensuelle et annuelle
      </div>
      <div class="form-row" style="margin-bottom:.8rem;">
        <div>
          <label class="form-label">Mois</label>
          <input type="month" id="month-select" class="form-input">
        </div>
        <div>
          <label class="form-label">Annee</label>
          <input type="number" id="year-select" class="form-input" min="2000" max="2100">
        </div>
      </div>
      <button class="btn btn-secondary" id="btn-apply-period">
        Appliquer la periode
      </button>
    </div>

    <div class="card">
      <div class="card-title">
        <i class="fas fa-list"></i> Synthese periode
      </div>
      <div id="period-summary"></div>
    </div>
  </div>
</div>

<!-- Objectifs -->
<div id="goals-page" class="page">
  <div class="container">
    <div class="card">
      <div class="card-title">
        <i class="fas fa-trophy"></i> Objectifs d'epargne
      </div>
      <button class="btn btn-success" id="btn-new-goal">
        <i class="fas fa-plus"></i> Nouvel objectif
      </button>
    </div>
    <div class="card">
      <div id="goals-list"></div>
    </div>
  </div>
</div>

<!-- Profils -->
<div id="profiles-page" class="page">
  <div class="container">
    <div class="card">
      <div class="card-title">
        <i class="fas fa-users"></i> Profils
      </div>
      <form id="profile-form" style="margin-bottom:1rem;">
        <div class="form-row">
          <div>
            <label class="form-label">Nom du profil</label>
            <input type="text" id="profile-name" class="form-input" required>
          </div>
          <div style="align-self:flex-end;">
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-plus"></i> Ajouter
            </button>
          </div>
        </div>
      </form>
      <div id="profiles-list"></div>
      <p class="small-text">
        Creez un profil par personne (par exemple : Moi, Compagne, Couple, Coloc 1, etc.).
      </p>
    <div class="card">
      <div class="card-title">
        <i class="fas fa-object-group"></i> Groupes de profils
      </div>
      <form id="group-form" style="margin-bottom:1rem;">
        <div class="form-row">
          <div>
            <label class="form-label">Nom du groupe</label>
            <input type="text" id="group-name" class="form-input" placeholder="Ex : Couple" required>
          </div>
          <div style="align-self:flex-end;">
            <button type="submit" class="btn btn-secondary">
              <i class="fas fa-plus"></i> Ajouter le groupe
            </button>
          </div>
        </div>
        <p class="small-text" style="margin-top:.3rem;">
          Cochez les profils qui appartiennent a ce groupe :
        </p>
        <div id="group-members"></div>
      </form>
      <div id="groups-list"></div>
      <p class="small-text">
        Exemple : groupe "Couple" avec les profils "Moi" et "Compagne".
      </p>
    </div>

    </div>

    <div class="card">
      <div class="card-title">
        <i class="fas fa-scale-balanced"></i> Soldes entre profils (type Tricount)
      </div>
      <div id="balances-matrix"></div>
      <p class="small-text">
        Les soldes sont calcules a partir des depenses communes reparties par pourcentage.
      </p>
    </div>
  </div>
</div>

<!-- Rapports -->
<div id="reports-page" class="page">
  <div class="container">
    <div class="card">
      <div class="card-title">
        <i class="fas fa-file-alt"></i> Rapports
      </div>
      <div id="report-summary"></div>
      <div style="margin-top:1rem;display:flex;gap:.5rem;flex-wrap:wrap;">
        <button class="btn btn-primary" id="btn-export-csv">
          <i class="fas fa-file-csv"></i> Exporter CSV
        </button>
        <button class="btn btn-danger" id="btn-clear-data">
          <i class="fas fa-trash"></i> Reinitialiser toutes les donnees
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Transactions recurrentes -->
<div id="recurring-page" class="page">
  <div class="container">
    <div class="card">
      <div class="card-title">
        <i class="fas fa-redo"></i> Transactions recurrentes
      </div>
      <div id="recurring-list"></div>
      <p class="small-text" style="margin-top:.5rem;">
        Ces lignes sont creees a partir de transactions existantes via le bouton "Rendre recurrente".<br>
        A chaque ouverture de l'application, toutes les mensualites manquantes jusqu'a aujourd'hui sont generees automatiquement.
      </p>
    </div>
  </div>
</div>

<!-- Modale transaction -->
<div id="transaction-modal" class="modal">
  <div class="modal-content">
    <h2 class="modal-title">Nouvelle transaction</h2>
    <form id="transaction-form">
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Type</label>
          <select id="transaction-type" class="form-select">
            <option value="expense">Depense</option>
            <option value="income">Revenu</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Montant (â‚¬)</label>
          <input type="number" id="transaction-amount" class="form-input" min="0" step="0.01" required>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Categorie</label>
        <input type="text" id="transaction-category" class="form-input" placeholder="Ex : Courses, Epargne vacances" required>
      </div>
      <div class="form-group">
        <label class="form-label">Associer a un objectif (optionnel)</label>
        <select id="transaction-goal" class="form-select">
          <option value="">Aucun</option>
        </select>
        <p class="small-text">
          Si tu choisis un objectif, la categorie sera automatiquement remplie avec celle de l'objectif.
        </p>
      </div>
      <div class="form-group">
        <label class="form-label">Description</label>
        <input type="text" id="transaction-description" class="form-input">
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Date</label>
          <input type="date" id="transaction-date" class="form-input" required>
        </div>
        <div class="form-group">
          <label class="form-label">Transaction commune ?</label>
          <select id="transaction-shared" class="form-select">
            <option value="no">Non (perso)</option>
            <option value="yes">Oui (commune)</option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Qui a paye ?</label>
        <select id="transaction-payer" class="form-select"></select>
        <p class="small-text">Choisissez la personne qui a avance l'argent pour cette depense commune.</p>
      </div>
      <div class="form-group">
        <label class="form-label">
          Profils et pourcentages
          <span class="small-text">(la somme doit faire 100 %)</span>
        </label>
        <div id="transaction-participants"></div>
        <button type="button" class="btn btn-secondary" style="margin-top:.5rem;" id="btn-auto-split">
          Repartir egalement
        </button>
      </div>
      <div class="form-row">
        <button type="submit" class="btn btn-primary">Enregistrer</button>
        <button type="button" class="btn btn-danger" id="btn-cancel-transaction">Annuler</button>
      </div>
    </form>
  </div>
</div>

<!-- Modale objectif -->
<div id="goal-modal" class="modal">
  <div class="modal-content">
    <h2 class="modal-title">Nouvel objectif d'epargne</h2>
    <form id="goal-form">
      <div class="form-group">
        <label class="form-label">Nom de l'objectif</label>
        <input type="text" id="goal-name" class="form-input" required>
      </div>
      <div class="form-group">
        <label class="form-label">Categorie d'epargne liee</label>
        <input type="text" id="goal-category" class="form-input" placeholder="Ex : Epargne vacances" required>
      </div>
      <div class="form-group">
        <label class="form-label">Montant cible (â‚¬)</label>
        <input type="number" id="goal-target" class="form-input" min="0" step="0.01" required>
      </div>
      <div class="form-group">
        <label class="form-label">Type de periode</label>
        <select id="goal-period-type" class="form-select">
          <option value="year">Annuelle</option>
          <option value="month">Mensuelle</option>
        </select>
      </div>
      <div class="form-row" id="goal-period-year-row">
        <div class="form-group">
          <label class="form-label">Annee</label>
          <input type="number" id="goal-year" class="form-input" min="2000" max="2100" required>
        </div>
        <div class="form-group" id="goal-month-group" style="display:none;">
          <label class="form-label">Mois</label>
          <select id="goal-month" class="form-select">
            <option value="1">Janvier</option><option value="2">Fevrier</option>
            <option value="3">Mars</option><option value="4">Avril</option>
            <option value="5">Mai</option><option value="6">Juin</option>
            <option value="7">Juillet</option><option value="8">Aout</option>
            <option value="9">Septembre</option><option value="10">Octobre</option>
            <option value="11">Novembre</option><option value="12">Decembre</option>
          </select>
        </div>
      </div>
      <div class="form-row">
        <button type="submit" class="btn btn-success">Enregistrer</button>
        <button type="button" class="btn btn-danger" id="btn-cancel-goal">Annuler</button>
      </div>
    </form>
  </div>
</div>

<div class="fab" id="fab-button" title="Ajouter une transaction">
  <i class="fas fa-plus"></i>
</div>

<nav class="bottom-nav">
  <div class="nav-item active" data-page="dashboard">
    <i class="fas fa-home"></i><span>Accueil</span>
  </div>
  <div class="nav-item" data-page="transactions">
    <i class="fas fa-exchange-alt"></i><span>Transactions</span>
  </div>
  <div class="nav-item" data-page="budgets">
    <i class="fas fa-calendar-alt"></i><span>Periodes</span>
  </div>
  <div class="nav-item" data-page="goals">
    <i class="fas fa-trophy"></i><span>Objectifs</span>
  </div>
  <div class="nav-item" data-page="profiles">
    <i class="fas fa-users"></i><span>Profils</span>
  </div>
  <div class="nav-item" data-page="reports">
    <i class="fas fa-file-alt"></i><span>Rapports</span>
  </div>
  <div class="nav-item" data-page="recurring">
    <i class="fas fa-redo"></i><span>Recurrent</span>
  </div>
</nav>
</nav>

<div id="toast" class="toast"></div>

<script>
class BudgetApp {
      constructor() {
    this.transactions = [];
    this.profiles = [];
    this.groups = [];
    this.goals = [];
    this.recurring = [];
    this.currentFilterType = "all";
    this.currentProfileView = "all";
    this.currentGroupView = "all";
    this.loadData();
    this.processRecurring();   // <--- AJOUT
    this.setupUI();
    this.renderAll();
  }

  processRecurring() {
    const today = new Date();
    this.recurring.forEach(rec => {
      let last = new Date(rec.lastGenerated);
      // On avance mois par mois jusqu'a aujourd'hui
      while (true) {
        // Prochaine date theorique
        let year = last.getFullYear();
        let month = last.getMonth() + 1; // 1-12
        // passer au mois suivant
        month++;
        if (month > 12) { month = 1; year++; }
        const nextDate = new Date(year, month-1, rec.dayOfMonth);
        if (nextDate > today) break;

        // VÃ©rifier si une transaction identique a dÃ©jÃ  Ã©tÃ© gÃ©nÃ©rÃ©e pour cette date
        const existsTx = this.transactions.some(t =>
          t.type === rec.type &&
          t.amount === rec.amount &&
          t.category === rec.category &&
          t.description === rec.description &&
          t.date === this.formatDateISO(nextDate)
        );
        if (!existsTx) {
          const newTx = {
            id: Date.now() + Math.random(),
            type: rec.type,
            amount: rec.amount,
            category: rec.category,
            description: rec.description + " (recurrent)",
            date: this.formatDateISO(nextDate),
            shared: rec.shared,
            shares: rec.shares,
            payerId: rec.payerId,
            goalId: rec.goalId || null
          };
          this.transactions.push(newTx);
        }
        // mettre a jour last pour continuer la boucle
        last = nextDate;
        rec.lastGenerated = this.formatDateISO(nextDate);
      }
    });
    this.saveData();
  }

  loadData() {
    try {
      const stored = localStorage.getItem("mb_multi_profiles");
                  if (stored) {
        const data = JSON.parse(stored);
        this.transactions = data.transactions || [];
        this.profiles = data.profiles || [];
        this.groups = data.groups || [];
        this.goals = data.goals || [];
        this.recurring = data.recurring || [];   // <--- AJOUT
      }

      if (this.profiles.length === 0) {
        this.profiles.push({ id: Date.now(), name: "Moi" });
      }
    } catch(e){}
  }

      saveData() {
    localStorage.setItem("mb_multi_profiles", JSON.stringify({
      transactions: this.transactions,
      profiles: this.profiles,
      groups: this.groups,
      goals: this.goals,
      recurring: this.recurring   // <--- AJOUT
    }));
  }

  clearAllData() {
    this.transactions = [];
    this.goals = [];
    this.saveData();
    this.renderAll();
    this.showToast("Donnees reinitialisees (profils conserves)");
  }

  formatCurrency(v){return v.toFixed(2).replace(".",",")+" â‚¬";}
  formatDate(d){return new Date(d).toLocaleDateString("fr-FR");}
  getMonthYear(dateStr){const d=new Date(dateStr);return{y:d.getFullYear(),m:d.getMonth()+1};}
  getYear(dateStr){return new Date(dateStr).getFullYear();}

  setupUI() {
    document.querySelectorAll(".nav-item").forEach(item=>{
      item.addEventListener("click",e=>{
        const page=e.currentTarget.getAttribute("data-page");
        this.showPage(page);
      });
    });
    document.getElementById("fab-button").addEventListener("click",()=>this.openTransactionModal());
    document.querySelectorAll(".modal").forEach(modal=>{
      modal.addEventListener("click",e=>{if(e.target===modal)modal.classList.remove("active");});
    });
    document.getElementById("transaction-form").addEventListener("submit",e=>{
      e.preventDefault();this.addTransaction();
    });
    document.getElementById("btn-cancel-transaction").addEventListener("click",()=>this.closeModal("transaction-modal"));
    document.getElementById("goal-form").addEventListener("submit",e=>{
      e.preventDefault();this.addGoal();
    });
    document.getElementById("btn-cancel-goal").addEventListener("click",()=>this.closeModal("goal-modal"));
    document.getElementById("btn-new-goal").addEventListener("click",()=>this.openGoalModal());
    document.getElementById("goal-period-type").addEventListener("change",()=>this.updateGoalPeriodFields());
    document.querySelectorAll(".tab").forEach(tab=>{
      tab.addEventListener("click",e=>{
        document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
        e.currentTarget.classList.add("active");
        this.currentFilterType=e.currentTarget.getAttribute("data-filter");
        this.renderTransactions();
      });
    });
    document.getElementById("btn-export-csv").addEventListener("click",()=>this.exportCSV());
    document.getElementById("btn-clear-data").addEventListener("click",()=>{
      if(confirm("Reinitialiser toutes les donnees (sauf profils) ?"))this.clearAllData();
    });
    document.getElementById("profile-form").addEventListener("submit",e=>{
      e.preventDefault();this.addProfile();
    });
    const now=new Date();
    document.getElementById("month-select").value=now.getFullYear()+"-"+String(now.getMonth()+1).padStart(2,"0");
    document.getElementById("year-select").value=now.getFullYear();
    document.getElementById("btn-apply-period").addEventListener("click",()=>this.renderPeriodSummary());
    const d=new Date().toISOString().split("T")[0];
    document.getElementById("transaction-date").value=d;
    document.getElementById("transaction-shared").addEventListener("change",()=>this.renderTransactionParticipants());
    document.getElementById("btn-auto-split").addEventListener("click",()=>this.autoSplitParticipants());
    document.getElementById("goal-year").value=now.getFullYear();
    document.getElementById("transaction-goal").addEventListener("change",()=>this.onTransactionGoalChange());
    // Groupes : formulaire
    const groupForm = document.getElementById("group-form");
    if (groupForm) {
      groupForm.addEventListener("submit", e => {
        e.preventDefault();
        this.addGroup();
      });
    }

  }

  showPage(page){
    document.querySelectorAll(".page").forEach(p=>p.classList.remove("active"));
    document.getElementById(page+"-page").classList.add("active");
    document.querySelectorAll(".nav-item").forEach(n=>n.classList.remove("active"));
    const nav=document.querySelector('.nav-item[data-page="'+page+'"]');
    if(nav)nav.classList.add("active");
  }

  openTransactionModal(){
    this.renderTransactionParticipants();
    this.renderTransactionGoalOptions();
    document.getElementById("transaction-modal").classList.add("active");
  }
  closeModal(id){const m=document.getElementById(id);if(m)m.classList.remove("active");}
  openGoalModal(){this.updateGoalPeriodFields();document.getElementById("goal-modal").classList.add("active");}
  updateGoalPeriodFields(){
    const type=document.getElementById("goal-period-type").value;
    document.getElementById("goal-month-group").style.display=type==="month"?"block":"none";
  }

  addProfile(){
    const nameInput=document.getElementById("profile-name");
    const name=nameInput.value.trim();if(!name)return;
    const id=Date.now();this.profiles.push({id,name});
    nameInput.value="";this.saveData();
    this.renderProfiles();this.renderProfileFilter();this.renderTransactionParticipants();
    this.showToast("Profil ajoute");
  }

  deleteProfile(id){
    const used=this.transactions.some(t=>t.shares&&t.shares[id]!=null);
    if(used){alert("Impossible de supprimer ce profil : il est utilise dans des transactions.");return;}
    this.profiles=this.profiles.filter(p=>p.id!==id);
    if(this.currentProfileView===id)this.currentProfileView="all";
    this.saveData();this.renderProfiles();this.renderProfileFilter();this.renderAll();
    this.showToast("Profil supprime");
  }
  renderGroupMembersSelector() {
    const container = document.getElementById("group-members");
    if (!container) return;
    if (this.profiles.length === 0) {
      container.innerHTML = '<p class="small-text">Ajoutez d abord des profils.</p>';
      return;
    }
    let html = "";
    this.profiles.forEach(p => {
      html += `
        <label class="small-text" style="display:block;margin-bottom:.2rem;">
          <input type="checkbox" class="group-member-check" value="${p.id}">
          ${p.name}
        </label>
      `;
    });
    container.innerHTML = html;
  }

  addGroup() {
    const nameInput = document.getElementById("group-name");
    const name = nameInput.value.trim();
    if (!name) return;
    const checks = Array.from(document.querySelectorAll(".group-member-check"));
    const memberIds = checks.filter(c => c.checked).map(c => Number(c.value));
    if (memberIds.length === 0) {
      alert("Selectionnez au moins un profil pour le groupe.");
      return;
    }
    const group = {
      id: Date.now(),
      name,
      memberIds
    };
    this.groups.push(group);
    nameInput.value = "";
    checks.forEach(c => c.checked = false);
    this.saveData();
    this.renderGroups();
    this.showToast("Groupe ajoute");
  }

  deleteGroup(id) {
    this.groups = this.groups.filter(g => g.id !== id);
    if (this.currentGroupView === id) this.currentGroupView = "all";
    this.saveData();
    this.renderGroups();
    this.renderAll();
    this.showToast("Groupe supprime");
  }

  renderGroups() {
    const container = document.getElementById("groups-list");
    if (!container) return;
    if (this.groups.length === 0) {
      container.innerHTML = '<div class="empty-state">Aucun groupe defini.</div>';
      return;
    }
    container.innerHTML = this.groups.map(g => {
      const names = g.memberIds.map(id => {
        const p = this.profiles.find(x => x.id === id);
        return p ? p.name : "?";
      }).join(", ");
      return `
        <div style="border-bottom:1px solid var(--border);padding:.4rem 0;display:flex;justify-content:space-between;align-items:center;">
          <div>
            <div style="font-weight:600;">${g.name}</div>
            <div class="small-text">Membres : ${names}</div>
          </div>
          <button class="btn-icon btn-delete-group" data-id="${g.id}" title="Supprimer le groupe">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      `;
    }).join("");
    container.querySelectorAll(".btn-delete-group").forEach(btn => {
      btn.addEventListener("click", e => {
        const id = Number(e.currentTarget.getAttribute("data-id"));
        if (confirm("Supprimer ce groupe ?")) {
          this.deleteGroup(id);
        }
      });
    });
  }


  renderTransactionParticipants(){
    const container=document.getElementById("transaction-participants");
    if(this.profiles.length===0){
      container.innerHTML='<p class="small-text">Aucun profil. Ajoutez des profils dans l onglet Profils.</p>';
    }else{
      const shared=document.getElementById("transaction-shared").value==="yes";
      let html="";
      if(!shared)html+='<p class="small-text">Transaction personnelle : choisissez un seul profil et mettez 100 %.</p>';
      else html+='<p class="small-text">Transaction commune : definissez un pourcentage pour chaque profil concerne.</p>';
      this.profiles.forEach(p=>{
        html+=`
          <div class="form-row" style="margin-bottom:.3rem;">
            <div>
              <label class="form-label small-text">
                <input type="checkbox" class="share-check" data-profile="${p.id}">
                ${p.name}
              </label>
            </div>
            <div>
              <input type="number" class="form-input share-percent"
                     data-profile="${p.id}" min="0" max="100" step="0.01"
                     placeholder="%">
            </div>
          </div>`;
      });
      container.innerHTML=html;
    }
    const payerSelect=document.getElementById("transaction-payer");
    if(payerSelect){
      payerSelect.innerHTML="";
      this.profiles.forEach(p=>{
        const opt=document.createElement("option");
        opt.value=p.id;opt.textContent=p.name;payerSelect.appendChild(opt);
      });
    }
  }

  renderTransactionGoalOptions(){
    const select=document.getElementById("transaction-goal");
    select.innerHTML='<option value="">Aucun</option>';
    this.goals.forEach(g=>{
      const periodLabel=g.periodType==="year"
        ?("AnnÃ©e "+g.year)
        :("Mois "+g.month+"/"+g.year);
      const opt=document.createElement("option");
      opt.value=g.id;
      opt.textContent=g.name+" ("+g.category+" Â· "+periodLabel+")";
      select.appendChild(opt);
    });
  }

  onTransactionGoalChange(){
    const goalIdStr=document.getElementById("transaction-goal").value;
    if(!goalIdStr)return;
    const goal=this.goals.find(g=>g.id===Number(goalIdStr));
    if(goal){
      document.getElementById("transaction-category").value=goal.category;
    }
  }

  autoSplitParticipants(){
    const checks=Array.from(document.querySelectorAll(".share-check"));
    const selected=checks.filter(c=>c.checked);
    if(selected.length===0){alert("Selectionnez au moins un profil.");return;}
    const each=100/selected.length;
    document.querySelectorAll(".share-percent").forEach(inp=>{
      const id=inp.getAttribute("data-profile");
      const isSel=selected.some(c=>c.getAttribute("data-profile")===id);
      inp.value=isSel?each.toFixed(2):"";
    });
  }

  addTransaction(){
    const type=document.getElementById("transaction-type").value;
    const amount=parseFloat(document.getElementById("transaction-amount").value||"0");
    const goalIdStr=document.getElementById("transaction-goal").value;
    let category=document.getElementById("transaction-category").value.trim();
    const description=document.getElementById("transaction-description").value.trim();
    const date=document.getElementById("transaction-date").value;
    const shared=document.getElementById("transaction-shared").value==="yes";
    if(!amount||!date){alert("Montant et date sont obligatoires.");return;}
    let goalId=null;
    if(goalIdStr){
      goalId=Number(goalIdStr);
      const goal=this.goals.find(g=>g.id===goalId);
      if(goal)category=goal.category;
    }
    if(!category){alert("Categorie obligatoire (automatique si objectif choisi).");return;}

    const checks=Array.from(document.querySelectorAll(".share-check"));
    const percInputs=Array.from(document.querySelectorAll(".share-percent"));
    const shares={};let sum=0;
    checks.forEach(chk=>{
      const id=chk.getAttribute("data-profile");
      if(!chk.checked)return;
      const inp=percInputs.find(i=>i.getAttribute("data-profile")===id);
      const val=parseFloat(inp.value||"0");
      if(val>0){shares[id]=val;sum+=val;}
    });
    if(Object.keys(shares).length===0){alert("Choisissez au moins un profil et un pourcentage.");return;}
    if(Math.abs(sum-100)>0.1){alert("La somme des pourcentages doit faire 100 (actuellement "+sum.toFixed(2)+").");return;}
    const payerIdStr=document.getElementById("transaction-payer").value;
    const payerId=payerIdStr?Number(payerIdStr):null;
    const tx={id:Date.now(),type,amount,category,description,date,shared,shares,payerId,goalId};
    this.transactions.unshift(tx);this.saveData();this.renderAll();this.closeModal("transaction-modal");
    document.getElementById("transaction-form").reset();
    document.getElementById("transaction-date").value=new Date().toISOString().split("T")[0];
    document.getElementById("transaction-shared").value="no";this.renderTransactionParticipants();
    this.renderTransactionGoalOptions();
    this.showToast("Transaction enregistree");
  }

  deleteTransaction(id){
    this.transactions=this.transactions.filter(t=>t.id!==id);
    this.saveData();this.renderAll();this.showToast("Transaction supprimee");
  }

    getFilteredTransactions(){
    return this.transactions.filter(t=>{
      if(this.currentFilterType!=="all" && t.type!==this.currentFilterType) return false;

      // Vue globale
      if(this.currentProfileView==="all" && this.currentGroupView==="all") return true;

      // Vue profil
      if(this.currentGroupView==="all" && this.currentProfileView!=="all") {
        return t.shares && t.shares[this.currentProfileView] != null;
      }

      // Vue groupe
      if(this.currentGroupView!=="all") {
        const group = this.groups.find(g => g.id === this.currentGroupView);
        if (!group) return false;
        const ids = group.memberIds.map(id => String(id));
        // la transaction concerne au moins un membre du groupe ?
        return Object.keys(t.shares || {}).some(id => ids.includes(id));
      }

      return true;
    });
  }

  askMakeRecurring(tx) {
    const dayStr = prompt(
      "Jour du mois pour cette transaction recurrente (1-28) :",
      new Date(tx.date).getDate()
    );
    if (!dayStr) return;
    const day = parseInt(dayStr, 10);
    if (isNaN(day) || day < 1 || day > 28) {
      alert("Jour invalide. Choisissez un nombre entre 1 et 28.");
      return;
    }
    // Verifier si une recurrence existe deja pour cette transaction (meme type + montant + categorie + description)
    const exists = this.recurring.some(r =>
      r.type === tx.type &&
      r.amount === tx.amount &&
      r.category === tx.category &&
      r.description === tx.description
    );
    if (exists) {
      alert("Une recurrence identique existe deja.");
      return;
    }
    const rec = {
      id: Date.now(),
      type: tx.type,
      amount: tx.amount,
      category: tx.category,
      description: tx.description,
      shared: tx.shared,
      shares: tx.shares,
      payerId: tx.payerId,
      goalId: tx.goalId || null,
      dayOfMonth: day,
      lastGenerated: tx.date  // derniere date generee (celle-ci)
    };
    this.recurring.push(rec);
    this.saveData();
    this.showToast("Transaction rendue recurrente (jour "+day+")");
  }

  // renvoie une date en AAAA-MM-JJ
  formatDateISO(d) {
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const day = String(d.getDate()).padStart(2,"0");
    return y+"-"+m+"-"+day;
  }

  addGoal(){
    const name=document.getElementById("goal-name").value.trim();
    const category=document.getElementById("goal-category").value.trim();
    const target=parseFloat(document.getElementById("goal-target").value||"0");
    const periodType=document.getElementById("goal-period-type").value;
    const year=parseInt(document.getElementById("goal-year").value||"0",10);
    let month=null;if(periodType==="month")month=parseInt(document.getElementById("goal-month").value,10);
    if(!name||!category||!target||!year){alert("Tous les champs sont obligatoires.");return;}
    const goal={id:Date.now(),name,category,target,periodType,year,month};
    this.goals.push(goal);this.saveData();
    this.renderGoals();this.renderGoalsSummary();
    this.closeModal("goal-modal");document.getElementById("goal-form").reset();
    document.getElementById("goal-year").value=new Date().getFullYear();
    this.showToast("Objectif enregistre");
  }

  deleteGoal(id){
    this.goals=this.goals.filter(g=>g.id!==id);
    this.saveData();
    this.renderGoals();this.renderGoalsSummary();
    this.showToast("Objectif supprime");
  }

  computeGoalProgress(goal){
    let txs=this.transactions.filter(t=>t.category===goal.category);
    if(goal.periodType==="year"){
      txs=txs.filter(t=>this.getYear(t.date)===goal.year);
    }else if(goal.periodType==="month"){
      txs=txs.filter(t=>{
        const {y,m}=this.getMonthYear(t.date);
        return y===goal.year&&m===goal.month;
      });
    }
    let sum=0;
    txs.forEach(t=>{
      if(t.type==="income")sum+=t.amount;
      else if(t.type==="expense")sum-=t.amount;
    });
    if(sum<0)sum=0;
    return sum;
  }

  computeBalances(){
    const profileIds=this.profiles.map(p=>p.id);
    const balances={};
    profileIds.forEach(id=>{
      balances[id]={};
      profileIds.forEach(j=>balances[id][j]=0);
    });
    this.transactions.forEach(t=>{
      if(!t.shared||t.type!=="expense")return;
      const amount=t.amount;
      const shares=t.shares||{};
      const ids=Object.keys(shares);if(ids.length===0)return;
      let payerId=t.payerId;
      if(!payerId||!ids.includes(String(payerId)))payerId=Number(ids[0]);
      ids.forEach(idStr=>{
        const id=Number(idStr);
        const pct=shares[idStr]/100;
        const part=amount*pct;
        if(id===payerId)return;
        balances[id][payerId]+=part;
      });
    });
    const net={};
    profileIds.forEach(a=>{
      net[a]={};
      profileIds.forEach(b=>{
        if(a===b)net[a][b]=0;
        else{
          const ab=balances[a][b]||0;
          const ba=balances[b][a]||0;
          net[a][b]=Math.max(ab-ba,0);
        }
      });
    });
    return net;
  }

        renderAll(){
    this.renderProfileFilter();
    this.renderDashboard();
    this.renderTransactions();
    this.renderProfiles();
    this.renderGroupMembersSelector();
    this.renderGroups();
    this.renderGoals();
    this.renderGoalsSummary();
    this.renderBalancesMatrix();
    this.renderReports();
    this.renderPeriodSummary();
    this.renderRecurring();
  }




  renderDashboard(){
    const now=new Date();
    const monthTx=this.getFilteredTransactions().filter(t=>{
      const {y,m}=this.getMonthYear(t.date);
      return y===now.getFullYear()&&m===now.getMonth()+1;
    });
    const totalInc=this.getFilteredTransactions().filter(t=>t.type==="income")
      .reduce((s,t)=>s+t.amount,0);
    const totalExp=this.getFilteredTransactions().filter(t=>t.type==="expense")
      .reduce((s,t)=>s+t.amount,0);
    const monthInc=monthTx.filter(t=>t.type==="income").reduce((s,t)=>s+t.amount,0);
    const monthExp=monthTx.filter(t=>t.type==="expense").reduce((s,t)=>s+t.amount,0);
    document.getElementById("total-balance").textContent=this.formatCurrency(totalInc-totalExp);
    document.getElementById("month-income").textContent=this.formatCurrency(monthInc);
    document.getElementById("month-expenses").textContent=this.formatCurrency(monthExp);
    const recent=this.getFilteredTransactions().slice(0,5);
    const list=document.getElementById("recent-transactions");
    if(recent.length===0)list.innerHTML='<div class="empty-state">Aucune transaction encore.</div>';
    else list.innerHTML=recent.map(t=>this.renderTransactionItemHTML(t)).join("");
  }

  renderTransactions(){
    const txs=this.getFilteredTransactions();
    const list=document.getElementById("transactions-list");
    if(txs.length===0){
      list.innerHTML='<div class="empty-state">Aucune transaction encore.</div>';
    }else{
      list.innerHTML=txs.map(t=>this.renderTransactionItemHTML(t,true)).join("");
      list.querySelectorAll(".btn-delete-tx").forEach(btn=>{
        btn.addEventListener("click",e=>{
          const id=Number(e.currentTarget.getAttribute("data-id"));
          if(confirm("Supprimer cette transaction ?"))this.deleteTransaction(id);
        });
      });
      // Rendre recurrente
      list.querySelectorAll(".btn-make-recurring").forEach(btn => {
        btn.addEventListener("click", e => {
          const id = Number(e.currentTarget.getAttribute("data-id"));
          const tx = this.transactions.find(t => t.id === id);
          if (!tx) return;
          this.askMakeRecurring(tx);
        });
      });

    }
  }
   renderRecurring() {
    const container = document.getElementById("recurring-list");
    if (!container) return;
    if (!this.recurring || this.recurring.length === 0) {
      container.innerHTML = '<div class="empty-state">Aucune transaction recurrente definie pour l instant.</div>';
      return;
    }

    container.innerHTML = this.recurring.map(rec => {
      const members = Object.keys(rec.shares || {}).map(id => {
        const p = this.profiles.find(x => x.id === Number(id));
        const name = p ? p.name : "?";
        const pct = rec.shares[id];
        return name + " " + pct.toFixed(2) + "%";
      }).join(", ");
      const typeLabel = rec.type === "income" ? "Revenu" : "Depense";
      const goal = this.goals.find(g => g.id === rec.goalId);
      const goalText = goal ? (" Â· Objectif : " + goal.name) : "";
      return `
        <div style="border-bottom:1px solid var(--border);padding:.4rem 0;display:flex;justify-content:space-between;align-items:center;">
          <div>
            <div style="font-weight:600;">${typeLabel} - ${rec.category}</div>
            <div class="small-text">
              Montant : ${this.formatCurrency(rec.amount)} Â· Jour du mois : ${rec.dayOfMonth}<br>
              Derniere generation : ${this.formatDate(rec.lastGenerated)}<br>
              ${members ? "Profils : " + members : ""}
              ${goalText}
            </div>
          </div>
          <div style="display:flex;gap:.25rem;">
            <button class="btn-icon btn-edit-recurring" data-id="${rec.id}" title="Modifier cette recurrence">
              <i class="fas fa-pen"></i>
            </button>
            <button class="btn-icon btn-delete-recurring" data-id="${rec.id}" title="Supprimer cette recurrence">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>
      `;
    }).join("");

    container.querySelectorAll(".btn-delete-recurring").forEach(btn => {
      btn.addEventListener("click", e => {
        const id = Number(e.currentTarget.getAttribute("data-id"));
        if (confirm("Supprimer cette transaction recurrente ?")) {
          this.deleteRecurring(id);
        }
      });
    });

    container.querySelectorAll(".btn-edit-recurring").forEach(btn => {
      btn.addEventListener("click", e => {
        const id = Number(e.currentTarget.getAttribute("data-id"));
        this.editRecurring(id);
      });
    });
  }



  renderTransactionItemHTML(t,withDelete=false){
    const icon=t.type==="expense"?"ðŸ’¸":"ðŸ’°";
    const sign=t.type==="expense"?"-":"+";
    const participants=Object.keys(t.shares||{}).map(id=>{
      const p=this.profiles.find(x=>x.id===Number(id));
      const name=p?p.name:"?";
      const pct=t.shares[id];return name+" "+pct.toFixed(2)+"%";
    }).join(", ");
    const payer=this.profiles.find(p=>p.id===t.payerId);
    const payerText=payer?(" Â· Paye par "+payer.name):"";
    const goal=this.goals.find(g=>g.id===t.goalId);
    const goalText=goal?(" Â· Objectif : "+goal.name):"";
        return `
      <div class="transaction-item">
        <div class="transaction-icon ${t.type}">${icon}</div>
        <div class="transaction-info">
          <div class="transaction-category">${t.category}</div>
          <div class="transaction-description">${t.description||""}</div>
          <div class="transaction-meta">
            ${this.formatDate(t.date)} Â·
            ${t.shared?'<span class="badge">Commune</span>':'<span class="badge">Perso</span>'}
            ${participants?(" Â· "+participants):""}
            ${payerText}
            ${goalText}
          </div>
        </div>
        <div style="display:flex;flex-direction:column;align-items:flex-end;gap:.25rem;">
          <div class="transaction-amount ${t.type}">
            ${sign}${this.formatCurrency(t.amount)}
          </div>
          ${withDelete?`
          <div style="display:flex;gap:.25rem;">
            <button class="btn-icon btn-make-recurring" data-id="${t.id}" title="Rendre recurrente">
              <i class="fas fa-redo"></i>
            </button>
            <button class="btn-icon btn-delete-tx" data-id="${t.id}" title="Supprimer">
              <i class="fas fa-trash"></i>
            </button>
          </div>`:""}
        </div>
      </div>`;
  }
  editRecurring(id) {
    const rec = this.recurring.find(r => r.id === id);
    if (!rec) return;

    // On propose de modifier montant, jour du mois, categorie, description
    const newAmountStr = prompt(
      "Nouveau montant (laisse vide pour conserver "+rec.amount.toFixed(2)+") :",
      rec.amount.toString()
    );
    if (newAmountStr === null) return; // annule
    let newAmount = rec.amount;
    if (newAmountStr.trim() !== "") {
      const v = parseFloat(newAmountStr.replace(",", "."));
      if (isNaN(v) || v <= 0) {
        alert("Montant invalide.");
        return;
      }
      newAmount = v;
    }

    const newDayStr = prompt(
      "Nouveau jour du mois (1-28, laisse vide pour conserver "+rec.dayOfMonth+") :",
      rec.dayOfMonth.toString()
    );
    if (newDayStr === null) return;
    let newDay = rec.dayOfMonth;
    if (newDayStr.trim() !== "") {
      const d = parseInt(newDayStr, 10);
      if (isNaN(d) || d < 1 || d > 28) {
        alert("Jour invalide. Choisissez un nombre entre 1 et 28.");
        return;
      }
      newDay = d;
    }

    const newCategory = prompt(
      "Nouvelle categorie (laisse vide pour conserver \""+rec.category+"\") :",
      rec.category
    );
    if (newCategory === null) return;
    const categoryFinal = newCategory.trim() === "" ? rec.category : newCategory.trim();

    const newDesc = prompt(
      "Nouvelle description (laisse vide pour conserver \""+(rec.description||"")+"\") :",
      rec.description || ""
    );
    if (newDesc === null) return;
    const descFinal = newDesc.trim() === "" ? rec.description : newDesc.trim();

    // Appliquer les changements
    rec.amount = newAmount;
    rec.dayOfMonth = newDay;
    rec.category = categoryFinal;
    rec.description = descFinal;

    this.saveData();
    this.renderRecurring();
    this.showToast("Recurrence modifiee");
  }
 deleteRecurring(id) {
    this.recurring = this.recurring.filter(r => r.id !== id);
    this.saveData();
    this.renderRecurring();
    this.showToast("Recurrence supprimee");
  }
    renderProfiles(){
    const list=document.getElementById("profiles-list");
    if(this.profiles.length===0){
      list.innerHTML='<div class="empty-state">Aucun profil. Ajoutez-en un ci-dessus.</div>';return;
    }
    list.innerHTML=this.profiles.map(p=>`
      <div style="display:flex;justify-content:space-between;align-items:center;padding:.4rem 0;border-bottom:1px solid var(--border);">
        <div>${p.name}</div>
        <button class="btn-icon" data-id="${p.id}" title="Supprimer">
          <i class="fas fa-trash"></i>
        </button>
      </div>`).join("");
    list.querySelectorAll(".btn-icon").forEach(btn=>{
      btn.addEventListener("click",e=>{
        const id=Number(e.currentTarget.getAttribute("data-id"));
        this.deleteProfile(id);
      });
    });
    // Mettre a jour la liste des membres pour la creation de groupe
    this.renderGroupMembersSelector();
  }


   renderProfileFilter(){
    const container = document.getElementById("profile-filter");
    let html = `<span class="small-text" style="margin-right:.3rem;">Vue :</span>`;
    // Vue globale
    html += `<div class="pill ${this.currentProfileView==="all" && this.currentGroupView==="all"?"active":""}" data-view-type="all" data-id="all">Tous</div>`;

    // Profils individuels
    this.profiles.forEach(p=>{
      const active = this.currentProfileView===p.id && this.currentGroupView==="all";
      html += `<div class="pill ${active?"active":""}" data-view-type="profile" data-id="${p.id}">${p.name}</div>`;
    });

    // Groupes
    this.groups.forEach(g=>{
      const active = this.currentGroupView===g.id;
      html += `<div class="pill ${active?"active":""}" data-view-type="group" data-id="${g.id}">${g.name}</div>`;
    });

    container.innerHTML = html;
    container.querySelectorAll(".pill").forEach(pill=>{
      pill.addEventListener("click", e=>{
        const type = e.currentTarget.getAttribute("data-view-type");
        const idStr = e.currentTarget.getAttribute("data-id");
        if (type === "all") {
          this.currentProfileView = "all";
          this.currentGroupView = "all";
        } else if (type === "profile") {
          this.currentProfileView = Number(idStr);
          this.currentGroupView = "all";
        } else if (type === "group") {
          this.currentGroupView = Number(idStr);
          this.currentProfileView = "all";
        }
        this.renderAll();
      });
    });
  }


  renderGoals(){
    const list=document.getElementById("goals-list");
    if(this.goals.length===0){
      list.innerHTML='<div class="empty-state">Aucun objectif. Creez-en un avec le bouton ci-dessus.</div>';return;
    }
    list.innerHTML=this.goals.map(goal=>{
      const current=this.computeGoalProgress(goal);
      const pct=goal.target>0?(current/goal.target)*100:0;
      const periodLabel=goal.periodType==="year"
        ?"Annee "+goal.year
        :"Mois "+goal.month+"/"+goal.year;
      return `
        <div class="goal-card">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem;">
            <div>
              <div style="font-weight:600;">${goal.name}</div>
              <div class="small-text">${goal.category} Â· ${periodLabel}</div>
            </div>
            <div style="display:flex;flex-direction:column;align-items:flex-end;gap:.25rem;">
              <div style="font-weight:700;color:var(--primary);">${pct.toFixed(0)}%</div>
              <button class="btn-icon btn-delete-goal" data-id="${goal.id}" title="Supprimer l'objectif">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
          <div class="progress-bar" style="height:8px;margin-bottom:.4rem;">
            <div class="progress-fill" style="width:${Math.min(pct,100)}%;"></div>
          </div>
          <div class="small-text">
            ${this.formatCurrency(current)} / ${this.formatCurrency(goal.target)}
          </div>
        </div>`;
    }).join("");
    list.querySelectorAll(".btn-delete-goal").forEach(btn=>{
      btn.addEventListener("click",e=>{
        const id=Number(e.currentTarget.getAttribute("data-id"));
        if(confirm("Supprimer cet objectif ?"))this.deleteGoal(id);
      });
    });
  }

  renderGoalsSummary(){
    const container=document.getElementById("goals-summary");
    if(this.goals.length===0){
      container.innerHTML='<div class="empty-state">Aucun objectif defini.</div>';return;
    }
    let html="";
    this.goals.forEach(goal=>{
      const current=this.computeGoalProgress(goal);
      const pct=goal.target>0?(current/goal.target)*100:0;
      html+=`
        <div style="margin-bottom:.4rem;">
          <div style="display:flex;justify-content:space-between;font-size:.8rem;">
            <span>${goal.name}</span><span>${pct.toFixed(0)}%</span>
          </div>
          <div class="progress-bar" style="height:6px;">
            <div class="progress-fill" style="width:${Math.min(pct,100)}%;"></div>
          </div>
        </div>`;
    });
    container.innerHTML=html;
  }

  renderBalancesMatrix(){
    const container=document.getElementById("balances-matrix");
    if(this.profiles.length<2){
      container.innerHTML='<div class="empty-state">Ajoutez au moins deux profils pour voir les soldes.</div>';return;
    }
    const net=this.computeBalances();
    let html='<table style="width:100%;border-collapse:collapse;font-size:.8rem;">';
    html+='<tr><th style="text-align:left;padding:.3rem;"></th>';
    this.profiles.forEach(p=>{
      html+=`<th style="text-align:center;padding:.3rem;border-bottom:1px solid var(--border);">${p.name}</th>`;
    });
    html+='</tr>';
    this.profiles.forEach(row=>{
      html+=`<tr><td style="padding:.3rem;border-bottom:1px solid var(--border);">${row.name}</td>`;
      this.profiles.forEach(col=>{
        const v=net[row.id][col.id]||0;
        const txt=row.id===col.id?"-":(v>0?this.formatCurrency(v):"");
        html+=`<td style="padding:.3rem;text-align:center;border-bottom:1px solid var(--border);">${txt}</td>`;
      });
      html+='</tr>';
    });
    html+='</table>';
    container.innerHTML=html;

    let sentences="";
    this.profiles.forEach(a=>{
      this.profiles.forEach(b=>{
        if(a.id===b.id)return;
        const val=net[a.id][b.id]||0;
        if(val>0.01){
          sentences+=`<li>${a.name} doit ${this.formatCurrency(val)} a ${b.name}</li>`;
        }
      });
    });
    if(sentences){
      container.innerHTML+=`
        <div style="margin-top:.8rem;">
          <div style="font-weight:600;margin-bottom:.3rem;">Synthese des dettes :</div>
          <ul style="padding-left:1.2rem;font-size:.85rem;">${sentences}</ul>
        </div>`;
    }else{
      container.innerHTML+='<div class="empty-state">Aucune dette entre profils pour l instant.</div>';
    }
  }

  renderReports(){
    const txs=this.getFilteredTransactions();
    const container=document.getElementById("report-summary");
    if(txs.length===0){
      container.innerHTML='<div class="empty-state">Aucune transaction pour le moment.</div>';return;
    }
    const totalInc=txs.filter(t=>t.type==="income").reduce((s,t)=>s+t.amount,0);
    const totalExp=txs.filter(t=>t.type==="expense").reduce((s,t)=>s+t.amount,0);
    container.innerHTML=`
      <p class="small-text">Synthese globale (${this.currentProfileView==="all"?"tous profils":"profil filtre"})</p>
      <p><strong>Revenus :</strong> ${this.formatCurrency(totalInc)}</p>
      <p><strong>Depenses :</strong> ${this.formatCurrency(totalExp)}</p>
      <p><strong>Solde :</strong> ${this.formatCurrency(totalInc-totalExp)}</p>`;
  }

  renderPeriodSummary(){
    const monthVal=document.getElementById("month-select").value;
    const yearVal=parseInt(document.getElementById("year-select").value||"0",10);
    const container=document.getElementById("period-summary");
    if(!monthVal||!yearVal){
      container.innerHTML='<div class="empty-state">Choisissez une periode (mois et annee).</div>';return;
    }
    const [yStr,mStr]=monthVal.split("-");
    const myYear=parseInt(yStr,10);
    const myMonth=parseInt(mStr,10);
    const txs=this.getFilteredTransactions();
    const monthTx=txs.filter(t=>{
      const {y,m}=this.getMonthYear(t.date);
      return y===myYear&&m===myMonth;
    });
    const yearTx=txs.filter(t=>this.getYear(t.date)===yearVal);
    const mInc=monthTx.filter(t=>t.type==="income").reduce((s,t)=>s+t.amount,0);
    const mExp=monthTx.filter(t=>t.type==="expense").reduce((s,t)=>s+t.amount,0);
    const yInc=yearTx.filter(t=>t.type==="income").reduce((s,t)=>s+t.amount,0);
    const yExp=yearTx.filter(t=>t.type==="expense").reduce((s,t)=>s+t.amount,0);
    container.innerHTML=`
      <h4 style="margin-bottom:.4rem;">Mois selectionne (${myMonth}/${myYear})</h4>
      <p>Revenus : ${this.formatCurrency(mInc)}</p>
      <p>Depenses : ${this.formatCurrency(mExp)}</p>
      <p>Solde : ${this.formatCurrency(mInc-mExp)}</p>
      <hr style="margin:.8rem 0;">
      <h4 style="margin-bottom:.4rem;">Annee ${yearVal}</h4>
      <p>Revenus : ${this.formatCurrency(yInc)}</p>
      <p>Depenses : ${this.formatCurrency(yExp)}</p>
      <p>Solde : ${this.formatCurrency(yInc-yExp)}</p>`;
  }

  exportCSV(){
    if(this.transactions.length===0){
      this.showToast("Aucune transaction a exporter");return;
    }
    const headers=["Date","Type","Categorie","Description","Montant","Commune","Profils/Pourcentages","Paye par","Objectif"];
    const rows=this.transactions.map(t=>{
      const participants=Object.keys(t.shares||{}).map(id=>{
        const p=this.profiles.find(x=>x.id===Number(id));
        const name=p?p.name:"?";const pct=t.shares[id];
        return name+" "+pct.toFixed(2)+"%";
      }).join("; ");
      const payer=this.profiles.find(p=>p.id===t.payerId);
      const payerName=payer?payer.name:"";
      const goal=this.goals.find(g=>g.id===t.goalId);
      const goalName=goal?goal.name:"";
      return[
        t.date,
        t.type==="income"?"Revenu":"Depense",
        t.category,
        t.description,
        t.amount.toFixed(2),
        t.shared?"oui":"non",
        participants,
        payerName,
        goalName
      ];
    });
    let csv=headers.join(",")+"\n";
    rows.forEach(r=>{
      csv+=r.map(c=>'"'+String(c).replace(/"/g,'""')+'"').join(",")+"\n";
    });
    const blob=new Blob([csv],{type:"text/csv;charset=utf-8;"});
    const link=document.createElement("a");
    link.href=URL.createObjectURL(blob);
    link.download="transactions.csv";
    document.body.appendChild(link);link.click();document.body.removeChild(link);
    this.showToast("Export CSV effectue");
  }

  showToast(msg){
    const t=document.getElementById("toast");
    t.textContent=msg;t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"),2500);
  }
}

let app;
document.addEventListener("DOMContentLoaded",()=>{app=new BudgetApp();});
</script>
</body>
</html>
